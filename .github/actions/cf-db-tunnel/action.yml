name: Tunnel to database via CF
description: Open a database tunnel via Cloud Foundry CLI
inputs:
  cf-app-name:
    description: Application name
    required: true
  cf-service-name:
    description: Service name
    required: true
runs:
  using: "composite"
  steps:
    - name: Install connect-to-service CF plugin
      shell: bash
      run: |
        cf install-plugin -f https://github.com/cloud-gov/cf-service-connect/releases/download/1.1.0/cf-service-connect-linux-amd64
    
    - name: Open the tunnel and capture tunnel info
      shell: bash
      run: |
        # Capture the command output
        output=$(cf connect-to-service --no-client ${{ inputs.cf-app-name }} ${{ inputs.cf-service-name }})
        
        # Parse each line; trim extra whitespace using xargs
        host=$(echo "$output" | grep "^Host:" | awk '{print $2}' | xargs)
        port=$(echo "$output" | grep "^Port:" | awk '{print $2}' | xargs)
        username=$(echo "$output" | grep "^Username:" | awk '{print $2}' | xargs)
        password=$(echo "$output" | grep "^Password:" | awk '{print $2}' | xargs)
        dbname=$(echo "$output" | grep "^Name:" | awk '{print $2}' | xargs)

        # Export the values as outputs
        echo "host=${host}" >> $GITHUB_OUTPUT
        echo "port=${port}" >> $GITHUB_OUTPUT
        echo "username=${username}" >> $GITHUB_OUTPUT
        echo "password=${password}" >> $GITHUB_OUTPUT
        echo "dbname=${dbname}" >> $GITHUB_OUTPUT